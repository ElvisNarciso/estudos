<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ENEM Power-Up: Miss√£o Aprova√ß√£o</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    
    <!-- √çcones (Feather Icons) -->
    <script src="https://unpkg.com/feather-icons"></script>
    
    <!-- Biblioteca de Gr√°ficos (Chart.js) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Biblioteca de Confetes -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>

    <style>
        :root {
            --bg-primary: #f0f9ff; --bg-secondary: #e0f2fe; --card-bg: linear-gradient(145deg, #ffffff, #f7fafc);
            --text-primary: #0c4a6e; --text-secondary: #374151; --text-accent: #4f46e5;
            --border-color: #e5e7eb; --button-primary-bg: #4f46e5; --button-primary-hover: #4338ca;
            --legendary-border-gradient: linear-gradient(120deg, #f59e0b, #ef4444, #8b5cf6, #3b82f6, #f59e0b);
        }
        .dark {
            --bg-primary: #111827; --bg-secondary: #0f172a; --card-bg: linear-gradient(145deg, #1f2937, #111827);
            --text-primary: #e5e7eb; --text-secondary: #9ca3af; --text-accent: #818cf8;
            --border-color: #374151; --button-primary-bg: #6366f1; --button-primary-hover: #4f46e5;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-primary); color: var(--text-primary); transition: background-color 0.3s ease, color 0.3s ease; }
        .main-container { background: var(--bg-secondary); transition: background-color 0.3s ease; }
        .legendary-card { border: 3px solid transparent; background: var(--card-bg) padding-box, var(--legendary-border-gradient) border-box; background-size: 200% 200%; animation: gradient-border-animation 4s linear infinite; transition: background 0.3s ease; }
        @keyframes gradient-border-animation { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        .alternative-btn { background-color: color-mix(in srgb, var(--card-bg), transparent 50%); border: 2px solid var(--border-color); color: var(--text-secondary); transition: all 0.2s ease-in-out; }
        .alternative-btn:hover { transform: translateY(-2px); border-color: var(--text-accent); }
        .alternative-btn.correct { background-color: #166534; color: white; border-color: #22c55e; }
        .alternative-btn.incorrect { background-color: #991b1b; color: white; border-color: #ef4444; }
        .alternative-btn[disabled] { cursor: not-allowed; opacity: 0.7; }
        .screen { display: none; animation: fadeIn 0.5s ease; }
        .screen.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .modal-backdrop { background-color: rgba(0,0,0,0.8); }
        .review-filter-btn.active-filter { background-color: var(--button-primary-bg); color: white; }
        #theme-toggle { background: var(--border-color); color: var(--text-primary); }
        textarea { background-color: color-mix(in srgb, var(--bg-primary), #000 2%); border-color: var(--border-color); color: var(--text-secondary); }
    </style>
</head>
<body>
    <button id="theme-toggle" class="fixed top-4 right-4 z-50 p-2 rounded-full shadow-lg">
        <i id="theme-icon" data-feather="moon"></i>
    </button>

    <div id="app-container" class="min-h-screen flex flex-col items-center justify-center p-4 main-container">

        <!-- TELA INICIAL (HOME) -->
        <div id="home-screen" class="screen active text-center p-8 rounded-2xl shadow-2xl max-w-2xl w-full legendary-card">
            <h1 class="text-5xl font-black mb-2" style="color: var(--text-primary);">ENEM Power-Up</h1>
            <p class="text-xl mb-8 opacity-90" style="color: var(--text-secondary);">Sua jornada para a aprova√ß√£o come√ßa agora!</p>
            <div class="space-y-4">
                <button id="start-quiz-btn" class="w-full text-white font-bold py-4 px-6 rounded-xl text-lg transition-transform transform hover:scale-105 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none" style="background-color: var(--button-primary-bg);">Iniciar Novo Quiz</button>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <button id="stats-btn" class="w-full font-bold py-3 px-6 rounded-xl transition-transform transform hover:scale-105 shadow-md" style="background-color: var(--border-color); color: var(--text-secondary);">Meu Desempenho</button>
                    <button id="review-btn" class="w-full font-bold py-3 px-6 rounded-xl transition-transform transform hover:scale-105 shadow-md" style="background-color: var(--border-color); color: var(--text-secondary);">Revisar Quest√µes</button>
                </div>
            </div>
            <div class="mt-8 border-t-2 pt-6" style="border-color: var(--border-color);">
                <label for="json-upload" class="block mb-2 font-semibold text-lg" style="color: var(--text-primary);">Carregar arquivo JSON:</label>
                <input type="file" id="json-upload" accept=".json" class="block w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold cursor-pointer" style="color: var(--text-secondary);"/>
                <p id="file-status" class="text-sm mt-2" style="color: var(--text-secondary);">Nenhum arquivo carregado.</p>
                <div class="my-4 text-center text-sm" style="color: var(--text-secondary);">ou</div>
                <label for="json-paste-area" class="block mb-2 font-semibold text-lg" style="color: var(--text-primary);">Cole o c√≥digo JSON aqui:</label>
                <textarea id="json-paste-area" rows="4" class="w-full p-2 border rounded-md text-sm" placeholder="[ { ... } ]"></textarea>
                <button id="load-from-paste-btn" class="w-full mt-2 text-white font-semibold py-2 px-4 rounded-lg text-sm shadow-md" style="background-color: var(--button-primary-bg);">Carregar do Texto</button>
                <button id="how-to-json-btn" class="mt-6 text-sm underline" style="color: var(--text-accent);">Como formatar o arquivo JSON?</button>
            </div>
        </div>

        <!-- TELA DO QUIZ -->
        <div id="quiz-screen" class="screen p-6 md:p-8 rounded-2xl shadow-2xl max-w-4xl w-full legendary-card relative">
             <button class="close-screen-btn absolute top-4 right-4 z-10 hover:opacity-80" style="color: var(--text-secondary);"><i data-feather="x-circle" class="w-7 h-7"></i></button>
             <div class="flex justify-between items-center mb-4">
                <div class="flex items-center space-x-4">
                    <span id="question-counter" class="font-bold text-lg" style="color: var(--text-primary);"></span>
                    <span id="question-area" class="text-white px-3 py-1 text-sm font-semibold rounded-full" style="background-color: var(--button-primary-bg);"></span>
                </div>
                <div class="flex items-center space-x-4">
                    <span id="streak-counter" class="font-bold text-xl text-orange-500"></span>
                    <i data-feather="award" class="w-6 h-6 text-yellow-400"></i>
                    <span id="score" class="font-bold text-2xl" style="color: var(--text-primary);">0</span>
                </div>
            </div>
            <div class="w-full rounded-full h-2.5 mb-6" style="background-color: var(--border-color);"><div id="progress-bar" class="bg-yellow-500 h-2.5 rounded-full" style="width: 0%"></div></div>
            <div id="question-container" class="mb-6">
                <p id="question-id" class="font-semibold text-sm mb-2" style="color: var(--text-secondary);"></p>
                <p id="question-text" class="text-lg leading-relaxed" style="color: var(--text-primary);"></p>
                <img id="question-image" src="" alt="Imagem da quest√£o" class="mt-4 rounded-lg max-w-full h-auto mx-auto hidden">
            </div>
            <div id="alternatives-container" class="grid grid-cols-1 gap-3"></div>
            <div class="mt-6 text-center">
                <div id="feedback-message" class="h-8 mb-4 font-bold text-xl"></div>
                <div id="resolution-container" class="mt-4 text-left hidden">
                    <button id="toggle-resolution-btn" class="w-full md:w-auto text-sm font-semibold py-2 px-4 rounded-lg shadow-md flex items-center justify-center mx-auto" style="background-color: var(--border-color); color: var(--text-secondary);"><i data-feather="eye" class="w-4 h-4 mr-2"></i>Ver Resolu√ß√£o</button>
                    <div id="resolution-content" class="mt-4 p-4 rounded-lg text-sm hidden" style="background-color: color-mix(in srgb, var(--card-bg), #000000 10%); border-left: 4px solid var(--text-accent);"></div>
                </div>
                <button id="next-question-btn" class="w-full md:w-1/2 text-white font-bold py-3 px-6 rounded-xl text-lg transition-transform transform hover:scale-105 shadow-lg hidden mt-4" style="background-color: var(--button-primary-bg);">Pr√≥xima Quest√£o</button>
                <button id="finish-quiz-btn" class="w-full md:w-1/2 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-xl text-lg transition-transform transform hover:scale-105 shadow-lg hidden mt-4">Finalizar e Ver Resultados</button>
            </div>
        </div>

        <!-- TELA DE RESULTADOS DO QUIZ -->
        <div id="results-screen" class="screen p-8 rounded-2xl shadow-2xl max-w-3xl w-full legendary-card relative text-center">
            <button class="close-screen-btn absolute top-4 right-4 z-10 hover:opacity-80" style="color: var(--text-secondary);"><i data-feather="x-circle" class="w-7 h-7"></i></button>
            <h2 class="text-4xl font-black mb-2" style="color: var(--text-primary);">Quiz Finalizado!</h2>
            <p id="motivational-message" class="text-lg mb-6" style="color: var(--text-secondary);"></p>
            <div class="mb-6">
                <span class="text-2xl font-semibold" style="color: var(--text-secondary);">Sua pontua√ß√£o:</span>
                <span id="final-score" class="text-6xl font-bold ml-2" style="color: var(--text-accent);"></span>
            </div>
            <div id="study-suggestions-container" class="text-left bg-black/5 dark:bg-black/20 p-6 rounded-lg">
                <h3 class="text-xl font-bold mb-3" style="color: var(--text-primary);">Pontos para Melhorar:</h3>
                <ul id="study-suggestions-list" class="space-y-2 list-disc list-inside"></ul>
            </div>
             <div class="mt-8 grid grid-cols-1 md:grid-cols-2 gap-4">
                <button id="results-to-review-btn" class="w-full font-bold py-3 px-6 rounded-xl transition-transform transform hover:scale-105 shadow-md" style="background-color: var(--border-color); color: var(--text-secondary);">Revisar Quest√µes do Quiz</button>
                <button id="results-to-home-btn" class="w-full text-white font-bold py-3 px-6 rounded-xl transition-transform transform hover:scale-105 shadow-lg" style="background-color: var(--button-primary-bg);">Voltar ao In√≠cio</button>
            </div>
        </div>

        <!-- TELA DE ESTAT√çSTICAS -->
        <div id="stats-screen" class="screen p-8 rounded-2xl shadow-2xl max-w-4xl w-full legendary-card relative">
            <button class="close-screen-btn absolute top-4 right-4 z-10 hover:opacity-80" style="color: var(--text-secondary);"><i data-feather="x-circle" class="w-7 h-7"></i></button>
            <h2 class="text-4xl font-black mb-6 text-center" style="color: var(--text-primary);">Meu Desempenho Geral</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center mb-8">
                <div class="p-4 rounded-lg" style="background-color: color-mix(in srgb, var(--card-bg), #000000 10%);"><p class="text-lg font-bold" style="color: var(--text-primary);">Acertos Totais</p><p id="stats-accuracy" class="text-3xl font-bold text-green-500">0%</p></div>
                <div class="p-4 rounded-lg" style="background-color: color-mix(in srgb, var(--card-bg), #000000 10%);"><p class="text-lg font-bold" style="color: var(--text-primary);">Melhor Assunto</p><p id="stats-best-subject" class="text-xl font-bold text-sky-500 truncate">N/A</p></div>
                <div class="p-4 rounded-lg" style="background-color: color-mix(in srgb, var(--card-bg), #000000 10%);"><p class="text-lg font-bold" style="color: var(--text-primary);">Pior Assunto</p><p id="stats-worst-subject" class="text-xl font-bold text-red-500 truncate">N/A</p></div>
            </div>
            <div class="mb-8">
                <h3 class="text-2xl font-bold mb-4 text-center" style="color: var(--text-primary);">Linha do Tempo de Desempenho (% de acertos por quiz)</h3>
                <canvas id="performance-chart"></canvas>
            </div>
            <button id="clear-history-btn" class="w-full md:w-1/2 mx-auto text-red-700 bg-red-200 dark:text-red-200 dark:bg-red-800/50 font-bold py-3 px-6 rounded-xl transition-transform transform hover:scale-105 shadow-md flex items-center justify-center"><i data-feather="trash-2" class="w-5 h-5 mr-2"></i>Limpar Todo o Hist√≥rico</button>
        </div>

        <!-- TELA DE REVIS√ÉO -->
        <div id="review-screen" class="screen p-8 rounded-2xl shadow-2xl max-w-4xl w-full legendary-card relative">
            <button class="close-screen-btn absolute top-4 right-4 z-10 hover:opacity-80" style="color: var(--text-secondary);"><i data-feather="x-circle" class="w-7 h-7"></i></button>
            <h2 class="text-4xl font-black mb-6 text-center" style="color: var(--text-primary);">Revis√£o de Quest√µes</h2>
            <div class="flex justify-center space-x-4 mb-6">
                <button class="review-filter-btn" data-filter="all">Todas</button>
                <button class="review-filter-btn" data-filter="correct">Corretas</button>
                <button class="review-filter-btn" data-filter="incorrect">Incorretas</button>
            </div>
            <div id="review-container" class="space-y-6 max-h-[60vh] overflow-y-auto pr-4"></div>
        </div>
    </div>
    
    <!-- MODAL DE INSTRU√á√ïES JSON -->
    <div id="json-modal" class="fixed inset-0 z-50 items-center justify-center p-4 hidden modal-backdrop">
        <div class="rounded-2xl shadow-2xl max-w-3xl w-full p-8 relative legendary-card flex flex-col max-h-[90vh]">
            <button id="close-modal-btn" class="absolute top-4 right-4 z-10" style="color: var(--text-secondary);"><i data-feather="x" class="w-8 h-8"></i></button>
            <h3 class="text-3xl font-bold mb-4 text-yellow-400 flex-shrink-0">Instru√ß√µes para o JSON</h3>
            <div class="overflow-y-auto pr-4">
                <p class="mb-4" style="color: var(--text-secondary);">Para que a IA gere quest√µes compat√≠veis com a an√°lise de desempenho, use o prompt abaixo. A estrutura deve ser seguida <strong class="text-red-400">RIGOROSAMENTE</strong>.</p>
                <div class="text-left space-y-2 mb-4 text-sm" style="color: var(--text-secondary);">
                    <p><strong>Estrutura de cada Objeto de Quest√£o:</strong></p>
                    <ul class="list-disc list-inside space-y-1 pl-4">
                        <li><code>id</code> (String): Identificador √∫nico. Ex: "ENEM 2023 - Q91".</li>
                        <li><code>area</code> (String): Use um dos valores: "Ci√™ncias da Natureza", "Ci√™ncias Humanas", "Linguagens", "Matem√°tica".</li>
                        <li><code>assunto</code> (String): **OBRIGAT√ìRIO.** O t√≥pico espec√≠fico da quest√£o. Ex: "Logaritmos", "Revolu√ß√£o Industrial", "Interpreta√ß√£o de Texto", "Gen√©tica".</li>
                        <li><code>enunciado</code> (String): O texto completo da pergunta.</li>
                        <li><code>imagem</code> (String): URL para uma imagem. Se n√£o houver, deixe como string vazia: <code>""</code>.</li>
                        <li><code>alternativas</code> (Array): Lista com <strong>exatamente 5 objetos</strong>, cada um com <code>"letra"</code> (A, B, C, D, E) e <code>"texto"</code>.</li>
                        <li><code>respostaCorreta</code> (String): <strong>Apenas a letra mai√∫scula</strong> da resposta correta. Ex: "D".</li>
                        <li><code>resolucao</code> (String): (Opcional) Texto com a explica√ß√£o detalhada da resposta. Se n√£o houver, deixe como string vazia: <code>""</code>.</li>
                    </ul>
                </div>
                <div id="json-example-container" class="rounded-lg p-4 text-sm overflow-x-auto border" style="background-color: var(--bg-primary); border-color: var(--border-color);"><pre><code class="language-json" style="color: var(--text-secondary);">[{"id":"ENEM 2021 - Q140","area":"Matem√°tica","assunto":"Logaritmos","enunciado":"A Escala de Magnitude de Momento (abreviada como MMS e denotada como Mw), introduzida em 1979, substituiu a Escala Richter para medir a magnitude dos terremotos em termos de energia liberada. A Mw e a energia E (em joule) se relacionam pela f√≥rmula: Mw = -10,7 + (2/3)log10(E). O terremoto de Kobe, no Jap√£o, teve magnitude de 7,3 na escala Mw. Qual a ordem de grandeza da energia liberada?","imagem":"","alternativas":[{"letra":"A","texto":"10^15"},{"letra":"B","texto":"10^18"},{"letra":"C","texto":"10^21"},{"letra":"D","texto":"10^24"},{"letra":"E","texto":"10^27"}],"respostaCorreta":"E","resolucao":"Substituindo Mw = 7,3 na f√≥rmula: 7,3 = -10,7 + (2/3)log10(E). Somando 10,7 em ambos os lados: 18 = (2/3)log10(E). Multiplicando por 3/2: 18 * (3/2) = log10(E), o que resulta em 27 = log10(E). Pela defini√ß√£o de logaritmo, E = 10^27. A ordem de grandeza √© 10^27."}]</code></pre></div>
            </div>
            <div class="mt-4 flex-shrink-0"><button id="copy-json-prompt-btn" class="w-full text-white font-semibold py-2 px-4 rounded-lg text-sm shadow-md flex items-center justify-center" style="background-color: var(--button-primary-bg);"><i data-feather="copy" class="w-4 h-4 mr-2"></i>Copiar Prompt para IA</button></div>
        </div>
    </div>
    
    <!-- MODAL DE CONFIRMA√á√ÉO -->
    <div id="confirm-modal" class="fixed inset-0 z-50 items-center justify-center p-4 hidden modal-backdrop">
        <div class="rounded-2xl shadow-2xl max-w-sm w-full p-8 legendary-card text-center">
            <h3 id="confirm-title" class="text-2xl font-bold mb-4" style="color: var(--text-primary);">Voc√™ tem certeza?</h3>
            <p id="confirm-message" class="mb-6" style="color: var(--text-secondary);">Esta a√ß√£o √© irrevers√≠vel e apagar√° todo o seu progresso.</p>
            <div class="flex justify-center gap-4">
                <button id="confirm-cancel-btn" class="font-bold py-2 px-6 rounded-lg" style="background-color: var(--border-color); color: var(--text-secondary);">Cancelar</button>
                <button id="confirm-ok-btn" class="text-white font-bold py-2 px-6 rounded-lg bg-red-600 hover:bg-red-700">Confirmar</button>
            </div>
        </div>
    </div>

    <textarea id="json-prompt-to-copy" class="absolute -left-full"></textarea>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, query, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        let app, auth, db, userId, performanceChart;
        let allQuestions = [], currentQuizQuestions = [], userHistory = [], sessionHistory = [];
        let currentQuestionIndex = 0, score = 0, streak = 0, quizWrongSubjects = [];

        const dom = {
            appContainer: document.getElementById('app-container'),
            startQuizBtn: document.getElementById('start-quiz-btn'), jsonUpload: document.getElementById('json-upload'), fileStatus: document.getElementById('file-status'),
            jsonPasteArea: document.getElementById('json-paste-area'), loadFromPasteBtn: document.getElementById('load-from-paste-btn'), questionCounter: document.getElementById('question-counter'),
            questionArea: document.getElementById('question-area'), scoreDisplay: document.getElementById('score'), progressBar: document.getElementById('progress-bar'),
            questionId: document.getElementById('question-id'), questionText: document.getElementById('question-text'), questionImage: document.getElementById('question-image'),
            alternativesContainer: document.getElementById('alternatives-container'), feedbackMessage: document.getElementById('feedback-message'), resolutionContainer: document.getElementById('resolution-container'),
            toggleResolutionBtn: document.getElementById('toggle-resolution-btn'), resolutionContent: document.getElementById('resolution-content'), nextQuestionBtn: document.getElementById('next-question-btn'),
            finishQuizBtn: document.getElementById('finish-quiz-btn'), statsBtn: document.getElementById('stats-btn'), reviewBtn: document.getElementById('review-btn'),
            closeScreenBtns: document.querySelectorAll('.close-screen-btn'), jsonModal: document.getElementById('json-modal'), howToJsonBtn: document.getElementById('how-to-json-btn'),
            closeModalBtn: document.getElementById('close-modal-btn'), themeToggle: document.getElementById('theme-toggle'), themeIcon: document.getElementById('theme-icon'),
            copyJsonPromptBtn: document.getElementById('copy-json-prompt-btn'), jsonPromptToCopy: document.getElementById('json-prompt-to-copy'), streakCounter: document.getElementById('streak-counter'),
            finalScore: document.getElementById('final-score'), motivationalMessage: document.getElementById('motivational-message'), studySuggestionsList: document.getElementById('study-suggestions-list'),
            resultsToReviewBtn: document.getElementById('results-to-review-btn'), resultsToHomeBtn: document.getElementById('results-to-home-btn'),
            statsAccuracy: document.getElementById('stats-accuracy'), statsBestSubject: document.getElementById('stats-best-subject'), statsWorstSubject: document.getElementById('stats-worst-subject'),
            performanceChartCanvas: document.getElementById('performance-chart'), clearHistoryBtn: document.getElementById('clear-history-btn'),
            confirmModal: document.getElementById('confirm-modal'), confirmOkBtn: document.getElementById('confirm-ok-btn'), confirmCancelBtn: document.getElementById('confirm-cancel-btn'),
        };
        const screens = { home: document.getElementById('home-screen'), quiz: document.getElementById('quiz-screen'), stats: document.getElementById('stats-screen'), review: document.getElementById('review-screen'), results: document.getElementById('results-screen') };
        
        const applyTheme = (theme) => {
            document.documentElement.classList.toggle('dark', theme === 'dark');
            dom.themeIcon.setAttribute('data-feather', theme === 'dark' ? 'sun' : 'moon');
            feather.replace();
        };

        const toggleTheme = () => {
            const newTheme = document.documentElement.classList.contains('dark') ? 'light' : 'dark';
            localStorage.setItem('theme', newTheme);
            applyTheme(newTheme);
            if (performanceChart) renderPerformanceChart(); // Redesenha o gr√°fico com as novas cores
        };

        async function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        await loadData();
                    } else {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            try { await signInWithCustomToken(auth, __initial_auth_token); } catch (e) { await signInAnonymously(auth); }
                        } else { await signInAnonymously(auth); }
                    }
                });
            } catch (e) { userId = 'local'; loadData(); }
        }

        async function loadData() {
            if (!userId) return;
            if (userId === 'local') {
                userHistory = JSON.parse(localStorage.getItem('enemUserHistory_local')) || [];
                sessionHistory = JSON.parse(localStorage.getItem('enemSessionHistory_local')) || [];
                return;
            }
            const historyQuery = query(collection(db, `artifacts/${appId}/users/${userId}/history`));
            const sessionQuery = query(collection(db, `artifacts/${appId}/users/${userId}/sessions`));
            const [historySnapshot, sessionSnapshot] = await Promise.all([getDocs(historyQuery), getDocs(sessionQuery)]);
            userHistory = historySnapshot.docs.map(doc => ({ fbId: doc.id, ...doc.data() }));
            sessionHistory = sessionSnapshot.docs.map(doc => ({ fbId: doc.id, ...doc.data() }));
        }

        async function saveSession(sessionData) {
            sessionHistory.push(sessionData);
            if (!userId || userId === 'local') {
                localStorage.setItem('enemSessionHistory_local', JSON.stringify(sessionHistory));
                return;
            }
            try { await addDoc(collection(db, `artifacts/${appId}/users/${userId}/sessions`), sessionData); } catch (e) { console.error("Erro ao salvar sess√£o:", e); }
        }

        async function saveAnswer(answerData) {
            userHistory.push(answerData);
            if (!userId || userId === 'local') {
                localStorage.setItem('enemUserHistory_local', JSON.stringify(userHistory));
                return;
            }
            try { await addDoc(collection(db, `artifacts/${appId}/users/${userId}/history`), answerData); } catch (e) { console.error("Erro ao salvar resposta:", e); }
        }

        async function clearAllHistory() {
            userHistory = [];
            sessionHistory = [];
            if (userId === 'local') {
                localStorage.removeItem('enemUserHistory_local');
                localStorage.removeItem('enemSessionHistory_local');
            } else if (db) {
                const historyRef = collection(db, `artifacts/${appId}/users/${userId}/history`);
                const sessionsRef = collection(db, `artifacts/${appId}/users/${userId}/sessions`);
                const historySnapshot = await getDocs(historyRef);
                const sessionsSnapshot = await getDocs(sessionsRef);
                const batch = writeBatch(db);
                historySnapshot.forEach(doc => batch.delete(doc.ref));
                sessionsSnapshot.forEach(doc => batch.delete(doc.ref));
                await batch.commit();
            }
            if (performanceChart) performanceChart.destroy();
            showScreen('home');
        }

        const showConfirmationModal = (onConfirm) => {
            dom.confirmModal.style.display = 'flex';
            dom.confirmOkBtn.onclick = () => {
                onConfirm();
                dom.confirmModal.style.display = 'none';
            };
            dom.confirmCancelBtn.onclick = () => {
                dom.confirmModal.style.display = 'none';
            };
        };

        const processAndLoadQuestions = (json) => {
            if (Array.isArray(json) && json.length > 0) {
                allQuestions = json;
                localStorage.setItem('enemQuestions', JSON.stringify(allQuestions));
                updateHomeUI();
                return true;
            }
            return false;
        }
        
        const handleCopyJsonPrompt = () => {
            const exampleCode = document.querySelector('#json-example-container pre code').innerText;
            const promptText = `Crie um conjunto de 10 quest√µes para o ENEM no formato JSON. Siga ESTRITAMENTE a estrutura e as regras abaixo. O resultado final deve ser apenas o c√≥digo JSON puro, sem coment√°rios ou explica√ß√µes adicionais.

REGRAS E ESTRUTURA (para cada quest√£o):
1.  **id** (String): Identificador √∫nico. Ex: "ENEM 2021 - Q140".
2.  **area** (String): Categoria principal. Use um destes: "Ci√™ncias da Natureza", "Ci√™ncias Humanas", "Linguagens", "Matem√°tica".
3.  **assunto** (String): T√≥pico espec√≠fico da quest√£o. Ex: "Logaritmos", "Revolu√ß√£o Industrial", "Gen√©tica", "Vanguardas Europeias". Este campo √© OBRIGAT√ìRIO.
4.  **enunciado** (String): O texto completo da pergunta, incluindo textos de apoio se houver.
5.  **imagem** (String): URL de uma imagem de apoio. Se n√£o houver, use uma string vazia: "".
6.  **alternativas** (Array): Deve conter EXATAMENTE 5 objetos. Cada objeto deve ter "letra" (A, B, C, D, E) e "texto".
7.  **respostaCorreta** (String): APENAS a letra mai√∫scula da alternativa correta. Ex: "A".
8.  **resolucao** (String): (OPCIONAL) A explica√ß√£o detalhada do porqu√™ a resposta est√° correta. Se n√£o tiver, use uma string vazia: "".

EXEMPLO DE C√ìDIGO:
${exampleCode}`;
            dom.jsonPromptToCopy.value = promptText;
            dom.jsonPromptToCopy.select();
            dom.jsonPromptToCopy.setSelectionRange(0, 99999);
            try {
                document.execCommand('copy');
                const originalText = dom.copyJsonPromptBtn.innerHTML;
                dom.copyJsonPromptBtn.innerHTML = `<i data-feather="check" class="w-4 h-4 mr-2"></i> Copiado!`;
                feather.replace();
                setTimeout(() => { dom.copyJsonPromptBtn.innerHTML = originalText; feather.replace(); }, 2000);
            } catch (err) { alert('N√£o foi poss√≠vel copiar o texto.'); }
        };

        const init = async () => {
            applyTheme(localStorage.getItem('theme') || 'light');
            await initializeFirebase();
            const storedQuestions = localStorage.getItem('enemQuestions');
            if(storedQuestions) allQuestions = JSON.parse(storedQuestions);
            updateHomeUI();
            addEventListeners();
        };

        const showScreen = (screenName) => {
            Object.values(screens).forEach(screen => screen.classList.remove('active'));
            screens[screenName].classList.add('active');
            feather.replace();
        };

        const updateHomeUI = () => {
            dom.startQuizBtn.disabled = allQuestions.length === 0;
            dom.fileStatus.textContent = allQuestions.length > 0 ? `${allQuestions.length} quest√µes carregadas. Pronto para come√ßar!` : 'Nenhum arquivo carregado.';
            dom.fileStatus.style.color = allQuestions.length > 0 ? '#22c55e' : 'var(--text-secondary)';
        };

        const handleFileUpload = (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const json = JSON.parse(e.target.result);
                    if (!processAndLoadQuestions(json)) alert('Erro: O arquivo JSON est√° vazio ou em formato inv√°lido.');
                } catch (error) { alert('Erro ao ler o arquivo JSON. Verifique o formato.'); }
            };
            reader.readAsText(file);
        };

        const handlePasteLoad = () => {
            const jsonText = dom.jsonPasteArea.value;
            if (!jsonText.trim()) { alert('Por favor, cole o c√≥digo JSON na √°rea de texto.'); return; }
            try {
                const json = JSON.parse(jsonText);
                if (processAndLoadQuestions(json)) {
                    dom.jsonPasteArea.value = '';
                    alert('Quest√µes carregadas com sucesso a partir do texto!');
                } else alert('Erro: O JSON colado est√° vazio ou em formato inv√°lido.');
            } catch (error) { alert('Erro de formato no JSON. Verifique o texto colado.'); }
        };

        const startQuiz = () => {
            currentQuizQuestions = [...allQuestions].sort(() => 0.5 - Math.random()).slice(0, 10);
            currentQuestionIndex = 0; score = 0; streak = 0; quizWrongSubjects = [];
            updateStreakCounter();
            displayQuestion();
            showScreen('quiz');
        };

        const updateStreakCounter = () => {
            dom.streakCounter.innerHTML = streak > 1 ? `${streak} <span class="text-xl">üî•</span>` : '';
        };

        const displayQuestion = () => {
            dom.feedbackMessage.textContent = '';
            dom.nextQuestionBtn.classList.add('hidden');
            dom.finishQuizBtn.classList.add('hidden');
            dom.alternativesContainer.innerHTML = '';
            dom.resolutionContainer.classList.add('hidden');
            dom.resolutionContent.classList.add('hidden');
            
            const question = currentQuizQuestions[currentQuestionIndex];
            dom.questionCounter.textContent = `Quest√£o ${currentQuestionIndex + 1} de ${currentQuizQuestions.length}`;
            dom.scoreDisplay.textContent = score;
            dom.progressBar.style.width = `${((currentQuestionIndex + 1) / currentQuizQuestions.length) * 100}%`;
            dom.questionArea.textContent = question.area;
            dom.questionId.textContent = question.id;
            dom.questionText.textContent = question.enunciado;
            dom.questionImage.classList.toggle('hidden', !question.imagem || question.imagem.trim() === "");
            if (question.imagem) dom.questionImage.src = question.imagem;

            question.alternativas.forEach(alt => {
                const button = document.createElement('button');
                button.className = 'alternative-btn w-full text-left p-4 rounded-lg font-semibold';
                button.dataset.letra = alt.letra;
                button.innerHTML = `<span class="font-bold mr-3" style="color: var(--text-accent);">${alt.letra})</span> ${alt.texto}`;
                button.onclick = selectAnswer;
                dom.alternativesContainer.appendChild(button);
            });
        };

        const selectAnswer = (event) => {
            const selectedButton = event.currentTarget;
            const selectedAnswer = selectedButton.dataset.letra;
            const question = currentQuizQuestions[currentQuestionIndex];
            const isCorrect = selectedAnswer === question.respostaCorreta;

            dom.alternativesContainer.querySelectorAll('.alternative-btn').forEach(btn => btn.disabled = true);
            saveAnswer({ questionId: question.id, area: question.area, assunto: question.assunto, userAnswer: selectedAnswer, correctAnswer: question.respostaCorreta, isCorrect, timestamp: new Date().toISOString() });

            if (isCorrect) {
                selectedButton.classList.add('correct');
                dom.feedbackMessage.textContent = 'Resposta Correta!';
                dom.feedbackMessage.style.color = '#4ade80';
                score += 10; streak++;
            } else {
                selectedButton.classList.add('incorrect');
                dom.feedbackMessage.textContent = `Incorreto! A resposta era ${question.respostaCorreta}.`;
                dom.feedbackMessage.style.color = '#f87171';
                streak = 0;
                if (question.assunto) quizWrongSubjects.push(question.assunto);
                const correctButton = dom.alternativesContainer.querySelector(`[data-letra="${question.respostaCorreta}"]`);
                if(correctButton) correctButton.classList.add('correct');
            }
            
            if (question.resolucao) {
                dom.resolutionContainer.classList.remove('hidden');
                dom.resolutionContent.innerHTML = question.resolucao;
            }

            updateStreakCounter();
            dom.scoreDisplay.textContent = score;
            dom.nextQuestionBtn.classList.toggle('hidden', currentQuestionIndex >= currentQuizQuestions.length - 1);
            dom.finishQuizBtn.classList.toggle('hidden', currentQuestionIndex < currentQuizQuestions.length - 1);
        };

        const showResults = () => {
            const totalQuestions = currentQuizQuestions.length;
            const correctAnswers = score / 10;
            const accuracy = (correctAnswers / totalQuestions) * 100;
            
            saveSession({ timestamp: new Date().toISOString(), score, totalQuestions, correctAnswers, accuracy });

            dom.finalScore.textContent = score;
            if (accuracy >= 80) {
                dom.motivationalMessage.textContent = "Excelente desempenho! Voc√™ est√° no caminho certo para a aprova√ß√£o!";
                confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
            } else if (accuracy >= 50) {
                dom.motivationalMessage.textContent = "Bom trabalho! Continue focado nos pontos de melhoria e voc√™ chegar√° l√°.";
            } else {
                dom.motivationalMessage.textContent = "N√£o desanime! Cada erro √© uma oportunidade de aprender. Revise os t√≥picos e tente novamente.";
            }

            const uniqueSubjects = [...new Set(quizWrongSubjects)];
            dom.studySuggestionsList.innerHTML = '';
            if (uniqueSubjects.length > 0) {
                uniqueSubjects.forEach(subject => {
                    const li = document.createElement('li');
                    li.textContent = subject;
                    li.className = "text-sm";
                    li.style.color = 'var(--text-secondary)';
                    dom.studySuggestionsList.appendChild(li);
                });
            } else {
                dom.studySuggestionsList.innerHTML = `<li class="text-green-500 font-semibold">Parab√©ns! Voc√™ n√£o errou nenhuma quest√£o com assunto definido.</li>`;
            }
            showScreen('results');
        };

        const showStats = () => {
            if (userHistory.length === 0) { alert("Voc√™ ainda n√£o respondeu nenhuma quest√£o para ver as estat√≠sticas."); return; }
            
            const totalCorrect = userHistory.filter(h => h.isCorrect).length;
            dom.statsAccuracy.textContent = `${userHistory.length > 0 ? ((totalCorrect / userHistory.length) * 100).toFixed(1) : 0}%`;
            
            const subjectStats = {};
            userHistory.forEach(h => {
                if (!h.assunto) return;
                subjectStats[h.assunto] = subjectStats[h.assunto] || { total: 0, correct: 0 };
                subjectStats[h.assunto].total++;
                if (h.isCorrect) subjectStats[h.assunto].correct++;
            });

            let bestSubject = { name: 'N/A', accuracy: -1 };
            let worstSubject = { name: 'N/A', accuracy: 101 };
            
            for (const subject in subjectStats) {
                const stats = subjectStats[subject];
                const accuracy = (stats.correct / stats.total) * 100;
                if (accuracy > bestSubject.accuracy) bestSubject = { name: subject, accuracy };
                if (accuracy < worstSubject.accuracy) worstSubject = { name: subject, accuracy };
            }

            dom.statsBestSubject.textContent = bestSubject.name;
            dom.statsWorstSubject.textContent = worstSubject.name;
            if (bestSubject.name === worstSubject.name) dom.statsWorstSubject.textContent = 'N/A'; // Se s√≥ houver um assunto

            renderPerformanceChart();
            showScreen('stats');
        };

        const renderPerformanceChart = () => {
            if (performanceChart) performanceChart.destroy();
            const isDark = document.documentElement.classList.contains('dark');
            const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
            const fontColor = isDark ? '#e5e7eb' : '#374151';

            const labels = sessionHistory.map(s => new Date(s.timestamp).toLocaleDateString('pt-BR'));
            const data = sessionHistory.map(s => s.accuracy.toFixed(1));

            performanceChart = new Chart(dom.performanceChartCanvas, {
                type: 'line',
                data: { labels, datasets: [{
                    label: '% de Acertos', data,
                    borderColor: 'rgba(79, 70, 229, 1)',
                    backgroundColor: 'rgba(79, 70, 229, 0.2)',
                    fill: true, tension: 0.3
                }]},
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        y: { min: 0, max: 100, ticks: { color: fontColor }, grid: { color: gridColor } },
                        x: { ticks: { color: fontColor }, grid: { color: gridColor } }
                    },
                    plugins: { legend: { labels: { color: fontColor } } }
                }
            });
        };

        const showReview = (filter = 'all') => {
             if (userHistory.length === 0) { alert("Voc√™ ainda n√£o respondeu nenhuma quest√£o."); return; }
             const reviewContainer = document.getElementById('review-container');
             reviewContainer.innerHTML = '';
             const filteredHistory = userHistory.filter(h => filter === 'all' || (filter === 'correct' ? h.isCorrect : !h.isCorrect)).reverse();
             if (filteredHistory.length === 0) { reviewContainer.innerHTML = `<p class="text-center" style="color: var(--text-secondary);">Nenhuma quest√£o encontrada.</p>`; }

             filteredHistory.forEach(h => {
                 const questionData = allQuestions.find(q => q.id === h.questionId);
                 if (!questionData) return;
                 const alternativesHtml = questionData.alternativas.map(alt => `<li class="pl-8 py-1 ${alt.letra === h.correctAnswer ? 'text-green-400 font-bold' : ''} ${alt.letra === h.userAnswer && !h.isCorrect ? 'text-red-400 line-through' : ''}" style="color: var(--text-secondary);">${alt.letra}) ${alt.texto}</li>`).join('');
                 const resolutionHtml = questionData.resolucao ? `<div class="mt-4 p-3 rounded-lg text-sm" style="background-color: color-mix(in srgb, var(--bg-primary), #000 2%); border-left: 3px solid var(--text-accent);"><h4 class="font-bold mb-1" style="color: var(--text-primary);">Resolu√ß√£o:</h4><p style="color: var(--text-secondary);">${questionData.resolucao}</p></div>` : '';
                 reviewContainer.innerHTML += `<div class="p-5 rounded-lg" style="background-color: color-mix(in srgb, var(--card-bg), #000000 10%);"><p class="font-bold text-sm" style="color: var(--text-accent);">${questionData.id} - ${questionData.area}</p><p class="my-2" style="color: var(--text-primary);">${questionData.enunciado}</p><ul class="list-none mt-3 text-sm">${alternativesHtml}</ul>${resolutionHtml}<p class="mt-3 text-xs" style="color: var(--text-secondary); opacity: 0.7;">Respondido em: ${new Date(h.timestamp).toLocaleString('pt-BR')}</p></div>`;
             });
             document.querySelectorAll('.review-filter-btn').forEach(btn => btn.classList.toggle('active-filter', btn.dataset.filter === filter));
             showScreen('review');
        };
        
        const addEventListeners = () => {
            dom.themeToggle.addEventListener('click', toggleTheme);
            dom.jsonUpload.addEventListener('change', handleFileUpload);
            dom.loadFromPasteBtn.addEventListener('click', handlePasteLoad);
            dom.copyJsonPromptBtn.addEventListener('click', handleCopyJsonPrompt);
            dom.startQuizBtn.addEventListener('click', startQuiz);
            dom.toggleResolutionBtn.addEventListener('click', () => dom.resolutionContent.classList.toggle('hidden'));
            dom.nextQuestionBtn.addEventListener('click', () => { currentQuestionIndex++; displayQuestion(); });
            dom.finishQuizBtn.addEventListener('click', showResults);
            dom.statsBtn.addEventListener('click', showStats);
            dom.reviewBtn.addEventListener('click', () => showReview());
            dom.resultsToReviewBtn.addEventListener('click', () => showReview());
            dom.resultsToHomeBtn.addEventListener('click', () => showScreen('home'));
            dom.clearHistoryBtn.addEventListener('click', () => showConfirmationModal(clearAllHistory));
            document.querySelectorAll('.review-filter-btn').forEach(btn => btn.addEventListener('click', (e) => showReview(e.currentTarget.dataset.filter)));
            dom.closeScreenBtns.forEach(btn => btn.addEventListener('click', () => showScreen('home')));
            dom.howToJsonBtn.addEventListener('click', () => dom.jsonModal.style.display = 'flex');
            dom.closeModalBtn.addEventListener('click', () => dom.jsonModal.style.display = 'none');
            dom.jsonModal.addEventListener('click', (e) => { if (e.target === dom.jsonModal) dom.jsonModal.style.display = 'none'; });
        };

        init();
    </script>
</body>
</html>
